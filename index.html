<!DOCTYPE html>
<html lang="zh-cn">
<head>
  <meta charset="utf-8" />
  <meta http-equiv="X-UA-Compatible" content="IE=Edge,chrome=1" />
  <title>Replace bilibili bofqi</title>
  <meta name="keywords" content="bilibili, bofqi, 哔哩哔哩, 播放器, cid" />
  <meta name="description" content="替换bilibili.tv ( bilibili.kankanews.com ) 播放器为原生播放器，直接外站跳转链接可长按选择播放位置，处理少量未审核或仅限会员的视频。" />
  <link rel="canonical" href="https://tiansh.github.io/rbb/">
  <style>
    html, body { font-family: "Microsoft YaHei",Helvetica,Arial,sans-serif; font-size: 16px; font-weight: normal; line-height: 24px; margin: 0; padding: 0; }
    body { background: #f0f0f0; padding-bottom: 40px; }
    #main-body { width: 960px; margin: 0 auto; }
    h1, h2, h3, h4, h5, h6 { margin: 0; padding: 0; font-size: 100%; font-weight: normal; }
    a, a:hover, a:active, a:visited { text-decoration: none; color: #f25d8e; outline: none; }
    a img { border: none; }
    .lazy { visibility: hidden; }
    h1 { color:#D95E7F; font-size: 40px; line-height: 60px; margin: 40px 0 20px 0; padding: 0; font-weight: bold; }
    header { display: block; height: 200px; }
    header li { list-style: none; }
    #intro { border: 2px solid #F25D8E; float: left; height: 120px; line-height: 30px; font-size: 20px; padding: 18px; background: #f8f8f8; border-radius: 8px; margin-left: 30px; color: #333; }
    #intro strong { color: #000; font-weight: normal; }
    #side-buttons { width: 400px; height: 160px; float: right; padding: 0; text-align: right; margin-right: 30px; }
    #install { background: #F25D8E; color: #fff; font-size: 32px; line-height: 50px; padding: 10px 50px; width: 300px; clear: both; display: block; float: right; text-align: center }
    #install:hover { background: #f32b6d; }
    #report { float: right; width: 100%; height: 70px; padding: 20px 0 0; display: block; font-size: 16px; }
    #report1, #report2 { height: 80px; width: 48%; display: block; }
    #report1 { float: left; }
    #report2 { float: right; }
    #report a { width: 100%; background: #e1e1e1; display: block; height: 40px; line-height: 40px; color: #aaa; text-align: center; }
    #report a:hover { background: #fdb4c8; color: #fff; }
    #report span { width: 100%; text-align: center; display: block; line-height: 30px; color: #aaa; }
    #install_instruct h3 { margin }
    h3 { font-size: 24px; font-weight: bold; border-bottom: 2px #ccc solid; padding: 10px 20px; margin: 20px 0 10px; }
    h3::before { background: #f32b6d; content: ""; display: block; float: left; height: 20px; left: -20px; position: relative; width: 10px; }
    .browser { width: 840px; padding: 10px 20px 10px 100px; position: relative; min-height: 100px; }
    .browser-icon { position: absolute; left: 20px; top: 20px; }
    .warning { color: red; font-weight: bold; }
    .in { padding: 5px 2em; border: 4px; }
    .p { margin: 0.5em 0; }
    ul { margin: 0; }
  </style>
  <script>
    window.onload = function () {
      var ua = navigator.userAgent;
      var odd = false, type = null;

      // 如果这漏了某个浏览器一定要告诉我～
      if (ua.match(/sogou\.com/i)) odd = true;
      if (ua.match(/soso\.com/i)) odd = true;
      if (ua.match(/TencentTraveler/i)) odd = true;
      if (ua.match(/QQBrowser/i)) odd = true;
      if (ua.match(/360se/i)) odd = true;
      if (ua.match(/TheWorld/i)) odd = true;
      if (ua.match(/MetaSr/i)) odd = true;
      if (ua.match(/baidubrowser/i)) odd = true;
      if (ua.match(/Maxthon/i)) odd = true;
      if (ua.match(/LBBrowser/i)) odd = true;

      if (ua.match(/MSIE/)) type = 'ie';
      if (ua.match(/Trident/)) type = 'ie';
      if (ua.match(/Firefox/)) type = 'firefox';
      if (ua.match(/Safari/)) type = 'safari';
      if (ua.match(/Chrome/)) type = 'chrome';
      if (ua.match(/Opera/)) type = 'opera';
      if (ua.match(/OPR/)) type = 'opera';

      if (type === 'ie') document.getElementById('ie').style.display = 'block';
      else if (type === 'safari' || type === 'chrome' && odd)
        document.getElementById('odd-webkit').style.display = 'block';
      else if (type) {
        var browser_list = document.getElementsByClassName('browser'), i;
        for (i = 0; i < browser_list.length; i++)
          browser_list[i].style.display = (browser_list[i].id === type) ? 'block' : 'none';
      }

      Array.apply(Array, document.querySelectorAll('.lazy')).forEach(function (o) { o.className = ''; })
    };
  </script>
</head>
<body>
<div id="main-body">
  <h1>Replace bilibili bofqi</h1>
  <header>
    <ul id="intro">
      <li><strong>替换bilibili播放器为原生播放器</strong></li>
      <li>检查是否替换后可以正常播放后自动替换</li>
      <li>链接上长按鼠标可<strong>处理直接跳转到外站的视频</strong></li>
      <li><strong>不访问第三方的服务器</strong>，保障隐私安全</li>
    </ul>
    <div id="side-buttons">
      <a id="install" href="https://tiansh.github.io/rbb/replace_bilibili_bofqi.user.js">安装脚本</a>
      <div id="report">
        <div id="report1">
          <a href="https://github.com/tiansh/rbb/issues" target="_blank">报告Bug</a>
          <span>在github上报告错误</span>
        </div>
        <div id="report2">
          <a href="http://member.bilibili.tv/#message?mid=1378109" target="_blank">私信我</a>
          <span>在bilibili上私信作者</span>
        </div>
      </div>
    </div>
  </header>
  <div id="install_instruct">
    <h3>安装教程</h3>
    <div class="in">
      <div id="ie" class="browser error" style="display: none;">
        <span class="browser-icon"><img class="lazy" src="img/logo/warning.png" alt="Chromium" width="64" height="64" /></span>
        <span class="warning">本脚本不支持IE浏览器！</span><br />
        本脚本不支持IE浏览器，请考虑从下面列出的三个浏览器中选择一个使用，点击浏览器图标以进入下载页面。
      </div>
      <div id="odd-webkit" class="browser error" style="display: none;">
        <span class="browser-icon"><img class="lazy" src="img/logo/warning.png" alt="Chromium" width="64" height="64" /></span>
        <span class="warning">本脚本可能不能很好地支持您使用的浏览器！</span><br />
        本脚本不支持Safari浏览器和一些分支自Chromium浏览器的浏览器。
        虽然您可以参考Chrome用户的使用方法安装本脚本，但我<strong>不保证</strong>在其上的运行效果，也<strong>不接受</strong>任何在这些浏览器上运行出现问题的错误报告。<br />
        建议您考虑使用下面列出的浏览器，点击浏览器图标以进入下载页面。
      </div>
      <div id="firefox" class="browser">
        <a href="http://www.mozilla.org/en-US/firefox/all/#zh-CN" class="browser-icon"><img class="lazy" src="img/logo/firefox.png" alt="Mozilla Firefox" width="64" height="64" /></a>
        <div>
          使用Mozilla Firefox浏览器的用户，需要安装<a href="https://addons.mozilla.org/zh-CN/firefox/addon/greasemonkey/">GreaseMonkey附加组件</a>以运行本脚本。<br />
          如果您已经安装了这个附加组件，<a href="replace_bilibili_bofqi.user.js">点此安装本脚本</a>，在弹出的对话框中确认脚本安装即可。
        </div>
        <div class="in">
          <div>可以使用Scriptish附加组件吗？</div>
          <div>本脚本同样支持Scriptish附加组件，但是要求Scriptish附加组件的版本在0.1.12以上。如果您使用的该附加组件是较旧的版本，请考虑更新附加组件或改用GreaseMonkey。</div>
        </div>
      </div>
      <div id="chrome" class="browser">
        <a href="https://www.google.com/intl/zh-CN/chrome/browser/?standalone=1" class="browser-icon"><img class="lazy" src="img/logo/chrome.png" alt="Google Chrome" width="64" height="64" /></a>
        <div>
          使用Google Chrome的用户，需要安装<a href="https://chrome.google.com/webstore/detail/tampermonkey/dhdgffkkebhmkfjojejmpbldmpobfkfo?hl=zh-CN">TamperMonkey 扩展程序</a>以运行本脚本。<br />
          如果您已经安装了这个扩展程序，<a href="replace_bilibili_bofqi.user.js">点此安装本脚本</a>，在打开的页面中确认脚本安装即可。
        </div>
      </div>
      <div id="opera" class="browser">
        <a href="http://www.opera.com/zh-cn" class="browser-icon"><img class="lazy" src="img/logo/opera.png" alt="Opera" width="64" height="64" /></a>
        <div>
          使用Opera的用户，需要安装<a href="https://addons.opera.com/zh-cn/extensions/details/tampermonkey-beta/">TamperMonkey Beta 扩展</a>以运行本脚本。<br />
          如果您已经安装了这个扩展，<a href="replace_bilibili_bofqi.user.js">点此安装本脚本</a>，在打开的页面中确认脚本安装即可。
        </div>
        <div class="in">
          <div>可以使用Violent monkey附加组件吗？</div>
          <div>本脚本同样支持最新版的Violent monkey，可能有少量兼容性问题，所以不推荐使用Violent monkey运行本脚本。但这些兼容问题不影响一般使用。</div>
        </div>
      </div>
    </div>
  </div>
  <h3>屏幕截图</h3>
  <div class="in">
    <figure>
      <img class="lazy" alt="Replace bilibili bofqi 长按鼠标显示的菜单" src="img/screenshot/menu.png" width="640" height="250" />
      <figcaption>Replace bilibili bofqi 长按视频链接可以出现选择播放位置的菜单，适用于直接跳转到外站的视频</figcaption>
    </figure>
    <figure>
      <a target="_blank" href="img/screenshot/replace.png"><img class="lazy" alt="Replace bilibili bofqi 成功替换播放器" src="img/screenshot/replace.png" width="640" height="152" /></a>
      <figcaption>Replace bilibili bofqi 检测到替换播放器可以正常播放后会自动替换播放器</figcaption>
    </figure>
  </div>
  <h3>恢复原生播放器</h3>
  <div class="in">
    <div class="p"><strong>脚本会自动将外站的播放器替换为原生的播放器。</strong></div>
    <div class="p">脚本主要作用于bilibili网站中一些不是原生播放器的视频。脚本会自动查找对应的原生播放器是否可用，若找到且确认可用会自动替换播放器。</div>
    <div class="p">这个过程主要分为查找视频地址（即cid）和检查视频地址是否可以正常播放两个步骤。检查视频是否可用的意义在于避免替换了不支持的视频后出现“非常抱歉”的16秒视频。</div>
    <div class="p">如果检查视频播放花费了太多的时间，脚本会询问是否忽略检查直接替换。如果你发现播放器左下角显示“加载视频地址…[完成]”，那么说明替换播放器已经成功。如果之后出现无限小电视的情况，可能是网络的问题，或者是视频源的问题。</div>
    <div class="p">检查是否可以正常播放时有如下几种常见错误：
      <ul>
        <li>“视频不允许在您当前所在地区播放”：有时候这类问题可以通过强制替换后反复刷新来解决（强制替换后顶部有刷新用按钮，请勿直接刷新网页）。此外更为稳定的做法，因为这些视频不允许在中国大陆等地区（可能包括日本）播放，所以您可以使用一个在这些地区以外的代理并将<span>http://interface.bilibili.cn/playurl?*</span>作为代理规则加入到代理列表中。关于什么是代理、怎么使用代理等问题不在本文的讨论范围内，请自行Google。</li>
        <li>“（该视频当前不可用）”或“无法替换**源的视频”：一些视频可能无法替换为原始的播放器，还有一些视频可能需要等待几小时到一天的时间才能替换播放器。如果该视频新出不久，而且您不是急着马上要看到的话，可以考虑过一段时间之后再试试。</li>
      </ul>
    </div>
    <div class="p">应用举例：<a target="_blank" href="http://www.bilibili.tv/video/av671693/">av671693: 【4月】某科学的超电磁炮S 16</a>、<a target="_blank" href="http://www.bilibili.tv/video/av788874/">av788874: 【10月】悠哉日常大王 01</a>。</div>
  </div>
  <h3>长按鼠标菜单</h3>
  <div class="in">
    <div class="p"><strong>在视频连接上按住鼠标左键，可以出现一个选择播放位置或选择分页的菜单。</strong></div>
    <div class="p">有些视频点击后自动跳转到其他站点，还有些会显示404，对于这类视频，您可以在视频链接上按住鼠标左键。脚本会弹出一个选择播放位置的菜单。在其中选择“生成页面”即可使用一个伪造的视频页面观看视频。如果脚本检查到视频不能正常播放，会在菜单的顶部给出错误信息进行提示。</div>
    <div class="p">对于多分页的视频，在链接上长按鼠标会弹出一个选择分页的菜单，你可以直接选择想要的分页而不必先打开第一个分页。</div>
    <div class="p">应用举例：<a target="_blank" href="http://www.bilibili.tv/video/av782436/">av782436: 【10月】KILL LA KILL 01</a>、<a target="_blank" href="http://www.bilibili.tv/video/av548141/">av548141: 【4月】我的妹妹不可能那么可爱 第二季 01</a>（需要将脚本应用到本页面，或在bilibili站点中使用，长按相应链接生效）。</div>
  </div>
  <h3>部分绕过用户限制</h3>
  <div class="in">
    <div class="p"><strong>脚本可以处理部分没有权限收看的视频。</strong></div>
    <div class="p">对于一些审核不通过的视频，或者在未登录的情况下访问一些仅限会员收看的视频。本脚本会试图通过相邻的视频地址推算当前视频的地址。</div>
    <div class="p">由于技术限制，这个推算很可能是不准确的，可能会有显示了错误的视频或者漏掉了一些分页的情况（一般不会发生多的情况）。效果上没什么保障。而且这一功能一般不太稳定，如果失败可以尝试刷新两次。这一功能仅为不准确地推断视频地址，不推荐长期用本脚本作为越过登录检查的工具。</div>
    <div class="p">如果您需要访问仅限会员收看的视频，建议您注册一个帐号。或者选用去其他通过第三方服务器获取视频地址的脚本。本脚本不会添加对第三方服务器的访问，所以不会对这一功能进行扩展。</div>
    <div class="p">
      应用举例：<a target="_blank" href="http://www.bilibili.tv/video/av97405/">av97405: 【柯南】绀碧之棺【剧场版】</a>、<a target="_blank" href="http://www.bilibili.tv/video/av908695/">av908695: 勿审（摸索吧！部活剧II 01）</a>。<br />
      （如上举例仅供测试用途，如想观看对应视频，请到<a target="_blank" href="http://www.bilibili.tv/video/av813658">av813658: 名侦探柯南剧场版</a>、<a href="http://www.bilibili.tv/video/av908756/">av908756: 【1月】摸索吧！部活剧 II 01【GDGDclub】</a>）<br />
    </div>
    <div class="p">注意，本功能只是因为上面的功能实现后所附带的功能，建议不要没事去翻那些没过审的视频，有些视频还是很毁三观的。</div>
  </div>
  <h3>显示新番视频列表隐藏视频</h3>
  <div class="in">
    <div class="p">由于一些众所周知的原因，一些视频不会显示在新番视频列表中，本脚本会重新加载新番视频列表并将他们显示出来。</div>
    <div class="p">你需要如处理直接跳转外站的视频一样的处理方法处理这类视频，虽然直接打开后可以在404页面上加载出视频，但效果不如生成页面好。</div>
  </div>
  <h3>脚本权限及用户隐私声明</h3>
  <div class="in">
    <div class="p">脚本使用了GreaseMonkey中的<code>GM_xmlhttpRequest</code>、 <code>GM_getValue</code>、 <code>GM_setValue</code>、 <code>GM_deleteValue</code>、 <code>GM_addStyle</code>、 <code>unsafeWindow</code>接口。</div>
    <div class="p">
      脚本使用<code>GM_xmlhttpRequest</code>用于网络访问，脚本进行的网络访问限于下列域名：<ul>
        <li>www.<span></span>bilibili.<span></span>tv</li>
        <li>bilibili.kankanews.<span></span>com</li>
        <li>secure.bilibili.<span></span>tv</li>
        <li>static-s.bilibili.<span></span>tv</li>
        <li>api.bilibili.<span></span>cn</li>
        <li>interface.bilibili.<span></span>cn</li>
        <li>static.hdslb.<span></span>com</li>
      </ul>
      这些域名都是bilibili.tv站点的相关域名。<br />
      此外在长按链接弹出菜单时，脚本还会访问对应链接指向的页面。
    </div>
    <div class="p">脚本使用了<code>GM_getValue </code>、 <code>GM_setValue</code>和<code>GM_deleteValue</code>用于本地存储，脚本在本地存储了：从网络上获取的cid和aid的对应关系。脚本缓存的数据仅供脚本自己使用，不会发送到网络上，本脚本、其他浏览器插件和用户有权限读取这些信息。</div>
    <div class="p">脚本使用了<code>GM_addStyle</code>用于向页面添加自定义的样式。</div>
    <div class="p">
      脚本使用了<code>unsafeWindow</code>用于一些对网页进行直接操作的功能，脚本使用该接口：<ul>
        <li>显示提示信息</li>
        <li>修改页面内容，以仿造视频页面，显示会自动跳转到外站的视频。</li>
      </ul>
    </div>
  </div>

  <h3>更新历史</h3>
  <div class="in">
    <ul>
      <li>2.35 ：修理无法找到不对应aid的视频的问题（<a href="https://github.com/tiansh/rbb/issues/2">#2</a>）</li>
      <li>2.34 ：直接外站跳转或404的视频长按菜单也有专题链接了，404上生成的页面支持视频描述和标签等</li>
      <li>2.33 ：二次元新番列表显示隐藏的视频</li>
      <li>2.32 ：修理对页面广告的兼容性（因为我一直在用ABP所以没发现）</li>
      <li>2.31 ：播放页面500也可以播给你看！</li>
      <li>2.30 ：少量代码整理，修理下拉菜单为空时边框显示，修理无法加载到信息的视频的菜单项</li>
      <li>2.29 ：没有播放器时，长按链接菜单将生成页面排到前面</li>
      <li>2.28 ：改善推断视频地址算法，修理获取标题失败问题；鉴于最近的一些情况，在404页面启用脚本</li>
      <li>2.27 ：生成页面增加显示番剧信息，修复生成页面长按鼠标菜单的相关问题</li>
      <li>2.26 ：调整样式，增强Chrome/Oprea在用户空间页面的兼容性</li>
      <li>2.25 ：修理Chrome/Oprea下显示专题链接的问题</li>
      <li>2.24 ：长按鼠标菜单显示专题链接</li>
      <li>2.23 ：长按选择播放位置的菜单中共享弹幕池的若干分页只显示最后一个分页</li>
      <li>2.22 ：将脚本迁移到github</li>
      <li>之前的版本请到 https://github.com/tiansh/rbb/blob/master/CHANGELOG.md 查看</li>
    </ul>
  </div>

  <h3>关于</h3>
  <div class="in">
    <div class="p">本脚本最早发布在 http://userscripts.org/scripts/show/176946 ，因为userscripts网站比较不稳定，现在主页搬移到了 https://tiansh.github.io/rbb/ 。</div>
    <div class="p">脚本使用 GNU GPL v3 和 CC BY-SA 3.0 协议发布，你可以选择合适的协议使用和继续发布。</div>
    <div class="p">我的B站ID：<a href="http://space.bilibili.tv/1378109/list.html">ts9(1378109)</a></div>
  </div>

  <h3>我的其他几个bilibili脚本</h3>
  <div class="in">
    <ul>
      <li><a target="_blank" href="http://userstyles.org/styles/91891/bilibili-header-fold">[Stylish] Bilibili Header Fold</a>：将bilibili.tv上方的图去掉，扩大浏览区域。 </li>
      <li><a target="_blank" href="/us-blbl/bilibili_player_no_ssl/">bilibili Player NO SSL</a>：使用 HTTP 页面显示 bilibili 的播放器而不是使用 HTTPS 页面，适用于一些因故不能访问 HTTPS 的情况。 </li>
      <li><a target="_blank" href="/us-blbl/bilibili_radio_danmuku/">Bilibili Radio Danmuku</a>：<a href="http://acg.tv/u4u">bilibil电台页面</a>弹幕辅助功能</li>
      <li><a target="_blank" href="/us-blbl/bilibili_small_window_auto_player_fullwin/">bilibili Small Window Auto Player FullWin</a>：视频页面，将浏览器页面缩放到480x360像素以下时，自动将播放器页面全屏</li>
    </ul>
  </div>
</div>
</body>
</html>
